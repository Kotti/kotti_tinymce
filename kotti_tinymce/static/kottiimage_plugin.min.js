tinymce.PluginManager.add("kottiimage",function(e){function n(){var e="";e='<table role="presentation" class="mce-panel mce-grid mce-grid-border">';e+="<tr>";for(var n=0;n<t.length;n++){e+='<td><a href="#" data-mce-index="'+n+'">'+(n+1)+"</a></td>"}e+="</tr>";e+="</table>";e+='<div class="mce-text-center">No Scaling</div>';return e}function r(e,t){function r(e,r){n.parentNode.removeChild(n);t({width:e,height:r})}var n=document.createElement("img");n.onload=function(){r(n.clientWidth,n.clientHeight)};n.onerror=function(){r()};n.src=e;var i=n.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(n)}function i(t){return function(){var n=e.settings.image_list;if(typeof n=="string"){tinymce.util.XHR.send({url:n,success:function(e){t(tinymce.util.JSON.parse(e))}})}else{t(n)}}}function s(i){function h(){var e=[{text:"None",value:""}];tinymce.each(i,function(t){e.push({text:t.text||t.title,value:t.value||t.url,menu:t.menu})});return e}function p(e){var t,n,r,i;t=s.find("#width")[0];n=s.find("#height")[0];r=t.value();i=n.value();if(s.find("#constrain")[0].checked()&&f&&l&&r&&i){if(e.control==t){i=Math.round(r/f*i);n.value(i)}else{r=Math.round(i/l*r);t.value(r)}}f=r;l=i}function d(e,t){var n,r,i,s,o;o="";if(e[-1]==="/"){e=e.slice(0,-1)}if(e){n=e.split("/");if(n.length>2){r=n[n.length-1];if(r.substring(0,4)==="span"){i=parseInt(r.slice(4),10);if(i===t){o=e}else{o=n.slice(0,-1).join("/")+"/span"+t}}else if(r==="image"){o=e+"/span"+t}}else{o=e+"/image/span"+t}}return o}function v(){function t(t){function r(){t.onload=t.onerror=null;e.selection.select(t);e.nodeChanged()}t.onload=function(){if(!n.width&&!n.height){u.setAttribs(t,{width:t.clientWidth,height:t.clientHeight})}r()};t.onerror=r}var n=s.toJSON();if(n.width===""){n.width=null}if(n.height===""){n.height=null}if(n.style===""){n.style=null}n={src:n.src,alt:n.alt,width:n.width,height:n.height,style:n.style};if(!a){n.id="__mcenew";e.insertContent(u.createHTML("img",n));a=u.get("__mcenew");u.setAttrib(a,"id",null)}else{u.setAttribs(a,n)}t(a)}function m(e){if(e){e=e.replace(/px$/,"")}return e}function g(e,n){var r;if(e<60){return r}tinymce.each(t,function(t){if(r){if(Math.abs(t.value[0]-e)<Math.abs(r.value[0]-e)){r=t}}else{r=t}});return r}function y(e,n){var r,i;if(e){if(e.match(/image$/)){i="Current Size: Original"}else if(n&&n>0&&n<t.length+1){i="Current Size: "+n}else{r=e.split("/");if(r.length>0){var s=r[r.length-1];if(s&&s.substring(0,4)==="span"){var o=parseInt(s.slice(4),10);if(o){i="Current Size: "+o}else{i="Current Size: None"}}else if(s==="image"){i="Current Size: Original"}}else{i=""}}}else{if(global_src){return y(global_src)}else{i="CurrentSize: No image selected"}}return i}function b(){r(this.value(),function(e){var t,n;if(e.width&&e.height){s.find("#width").value(e.width);s.find("#height").value(e.height);t=s.find("#src").value();n=g(e.width,e.height);if(n){s.find("#image_scale_label").text(y(t,n.number))}else{s.find("#image_scale_label").text(y(t))}}else{s.find("#width").value("");s.find("#height").value("");s.find("#image_scale_label").text("")}})}function w(){var e=[];tinymce.each(t,function(t){e.push({text:t.text,value:t.value,menu:t.menu})});return e}function E(){return{type:"panelbutton",text:"Change Size",popoverAlign:"bc-tl",panel:{type:"panel",html:n(),onmousemove:function(n){var r=n.target;if(r.nodeName=="A"){var i,s,o;i=e.dom.getParent(r,"table");s=parseInt(r.getAttribute("data-mce-index"),10);if(s!=this.lastPos){for(var u=0;u<t.length;u++){e.dom.toggleClass(i.rows[0].childNodes[u].firstChild,"mce-active",u<=s)}o=t[s].value;i.nextSibling.innerHTML=""+(s+1)+" (fit within "+o[0]+" x "+o[1]+")";this.lastPos=s}}},onmouseout:function(n){var r=n.target;if(r.nodeName=="A"){var i=e.dom.getParent(r,"table");for(var s=0;s<t.length;s++){e.dom.toggleClass(i.rows[0].childNodes[s].firstChild,"mce-active",false)}i.nextSibling.innerHTML="No scale"}},onclick:function(e){if(e.target.nodeName=="A"){var n,r,i,o;var u,a,c;var h,p,m,g;m=e.target;g=parseInt(m.getAttribute("data-mce-index"),10);e.preventDefault();n=s.find("#src");r=s.find("#image_scale_label");i=s.find("#width");o=s.find("#height");u=n.value();f=parseInt(i.value(),10);l=parseInt(o.value(),10);newImageScale=g+1;newImageSize=t[g].value;c=u;if(u&&newImageScale){c=d(u,newImageScale);n.value(c);h=newImageSize[0];p=newImageSize[1];if(f!==0){p=Math.round(h/f*l)}i.value(newImageSize[0]);o.value(p);console.log("setting image size",u,c,newImageScale);r.text(y(c,newImageScale))}if(s.find("#show_preview")[0].checked()){v()}this.hide()}}}}}function x(){function e(e){if(e.length>0&&/^[0-9]+$/.test(e)){e+="px"}return e}var t=s.toJSON();var n=u.parseStyle(t.style);delete n.margin;n["margin-top"]=n["margin-bottom"]=e(t.vspace);n["margin-left"]=n["margin-right"]=e(t.hspace);n["border-width"]=e(t.border);s.find("#style").value(u.serializeStyle(u.parseStyle(u.serializeStyle(n))))}var s,o,u=e.dom,a=e.selection.getNode();var f,l,c;f=u.getAttrib(a,"width");l=u.getAttrib(a,"height");global_src=u.getAttrib(a,"src");if(a.nodeName=="IMG"&&!a.getAttribute("data-mce-object")){o={src:u.getAttrib(a,"src"),alt:u.getAttrib(a,"alt"),width:f,height:l}}else{a=null}if(i){c={name:"target",type:"listbox",label:"Image list",values:h(),onselect:function(e){var t=s.find("#alt");if(!t.value()||e.lastControl&&t.value()==e.lastControl.text()){t.value(e.control.text())}s.find("#src").value(e.control.value())}}}var S=[{name:"src",type:"filepicker",label:"Image Source",tooltip:"An image content item is associated with an image file. Upload a new one, or pick an existing image file.",filetype:"image",autofocus:true,onchange:b},c,{type:"formitem",align:"center",spacing:5,label:"Image Size",items:[{type:"panel",layout:"flex",direction:"column",align:"center",spacing:5,items:[{type:"container",layout:"flex",direction:"row",align:"center",pack:"start",spacing:5,items:[E(),{type:"label",name:"image_scale_label",tooltip:"Size choices (1-12) are relative to the maximum width.",text:y()}]},{type:"container",layout:"flex",direction:"row",align:"center",spacing:5,items:[{type:"label",text:"Width and Height",tooltip:"Optionally, set width and size directly."},{name:"width",tooltip:"In pixels. Use integer number.",type:"textbox",maxLength:3,size:3,onchange:p},{type:"label",text:"x"},{name:"height",tooltip:"In pixels. Use integer number.",type:"textbox",maxLength:3,size:3,onchange:p},{name:"constrain",type:"checkbox",checked:true,tooltip:"Do not distort -- keep original proportions.",text:"Keep aspect ratio"}]}]}]},{name:"show_preview",type:"checkbox",checked:true,tooltip:"Show live preview of image in the edit window.",text:"Show Preview"}];if(e.settings.image_advtab){if(a){o.hspace=m(a.style.marginLeft||a.style.marginRight);o.vspace=m(a.style.marginTop||a.style.marginBottom);o.border=m(a.style.borderWidth);o.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(a,"style")))}s=e.windowManager.open({title:"Insert/edit image",data:o,bodyType:"tabpanel",body:[{title:"General",type:"form",padding:20,labelGap:30,spacing:10,items:S},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{label:"Alt text",name:"alt",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:x},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:v})}else{s=e.windowManager.open({title:"Edit image",data:o,body:S,onSubmit:v})}}var t=[{number:1,text:"span1",value:[60,120]},{number:2,text:"span2",value:[160,320]},{number:3,text:"span3",value:[260,520]},{number:4,text:"span4",value:[360,720]},{number:5,text:"span5",value:[460,920]},{number:6,text:"span6",value:[560,1120]},{number:7,text:"span7",value:[660,1320]},{number:8,text:"span8",value:[760,1520]},{number:9,text:"span9",value:[860,1720]},{number:10,text:"span10",value:[960,1920]},{number:11,text:"span11",value:[1060,2120]},{number:12,text:"span12",value:[1160,2320]}];e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:i(s),stateSelector:"img:not([data-mce-object])"});e.addMenuItem("image",{icon:"image",text:"Insert image",onclick:i(s),context:"insert",prependToContext:true})})
