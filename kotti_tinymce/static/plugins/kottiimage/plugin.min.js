tinymce.PluginManager.add("kottiimage",function(c){var w=[{number:1,text:"span1",value:[60,120]},{number:2,text:"span2",value:[160,320]},{number:3,text:"span3",value:[260,520]},{number:4,text:"span4",value:[360,720]},{number:5,text:"span5",value:[460,920]},{number:6,text:"span6",value:[560,1120]},{number:7,text:"span7",value:[660,1320]},{number:8,text:"span8",value:[760,1520]},{number:9,text:"span9",value:[860,1720]},{number:10,text:"span10",value:[960,1920]},{number:11,text:"span11",value:[1060,2120]},{number:12,text:"span12",value:[1160,2320]}];function e(t){return function(){var e=c.settings.image_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(e){t(tinymce.util.JSON.parse(e))}}):t(e)}}function t(e){var b,t,v,f,i,n,a=c.dom,l=c.selection.getNode();function r(e){var t,i,n,a;t=b.find("#width")[0],i=b.find("#height")[0],n=t.value(),a=i.value(),b.find("#constrain")[0].checked()&&v&&f&&n&&a&&(e.control==t?(a=Math.round(n/v*a),i.value(a)):(n=Math.round(a/f*n),t.value(n))),v=n,f=a}function x(){var i=b.toJSON();""===i.width&&(i.width=null),""===i.height&&(i.height=null),""===i.style&&(i.style=null),i={src:i.src,alt:i.alt,width:i.width,height:i.height,style:i.style},l?a.setAttribs(l,i):(i.id="__mcenew",c.insertContent(a.createHTML("img",i)),l=a.get("__mcenew"),a.setAttrib(l,"id",null)),function(e){function t(){e.onload=e.onerror=null,c.selection.select(e),c.nodeChanged()}e.onload=function(){i.width||i.height||a.setAttribs(e,{width:e.clientWidth,height:e.clientHeight}),t()},e.onerror=t}(l)}function o(e){return e&&(e=e.replace(/px$/,"")),e}function y(e,t){var i,n;if(e)if(e.match(/image$/))n="Current Size: Original";else if(t&&0<t&&t<w.length+1)n="Current Size: "+t;else if(0<(i=e.split("/")).length){var a=i[i.length-1];if(a&&"span"===a.substring(0,4)){var l=parseInt(a.slice(4),10);n=l?"Current Size: "+l:"Current Size: None"}else"image"===a&&(n="Current Size: Original")}else n="";else{if(global_src)return y(global_src);n="CurrentSize: No image selected"}return n}v=a.getAttrib(l,"width"),f=a.getAttrib(l,"height"),global_src=a.getAttrib(l,"src"),"IMG"!=l.nodeName||l.getAttribute("data-mce-object")?l=null:t={src:a.getAttrib(l,"src"),alt:a.getAttrib(l,"alt"),width:v,height:f},e&&(i={name:"target",type:"listbox",label:"Image list",values:(n=[{text:"None",value:""}],tinymce.each(e,function(e){n.push({text:e.text||e.title,value:e.value||e.url,menu:e.menu})}),n),onselect:function(e){var t=b.find("#alt");(!t.value()||e.lastControl&&t.value()==e.lastControl.text())&&t.value(e.control.text()),b.find("#src").value(e.control.value())}});var s=[{name:"src",type:"filepicker",label:"Image Source",tooltip:"An image content item is associated with an image file. Upload a new one, or pick an existing image file.",filetype:"image",autofocus:!0,onchange:function(){!function(e,i){var n=document.createElement("img");function t(e,t){n.parentNode.removeChild(n),i({width:e,height:t})}n.onload=function(){t(n.clientWidth,n.clientHeight)},n.onerror=function(){t()},n.src=e;var a=n.style;a.visibility="hidden",a.position="fixed",a.bottom=a.left=0,a.width=a.height="auto",document.body.appendChild(n)}(this.value(),function(e){var t,i,n,a;e.width&&e.height?(b.find("#width").value(e.width),b.find("#height").value(e.height),t=b.find("#src").value(),n=e.width,e.height,n<60||tinymce.each(w,function(e){a?Math.abs(e.value[0]-n)<Math.abs(a.value[0]-n)&&(a=e):a=e}),(i=a)?b.find("#image_scale_label").text(y(t,i.number)):b.find("#image_scale_label").text(y(t))):(b.find("#width").value(""),b.find("#height").value(""),b.find("#image_scale_label").text(""))})}},i,{type:"formitem",align:"center",spacing:5,label:"Image Size",items:[{type:"panel",layout:"flex",direction:"column",align:"center",spacing:5,items:[{type:"container",layout:"flex",direction:"row",align:"center",pack:"start",spacing:5,items:[{type:"panelbutton",text:"Change Size",popoverAlign:"bc-tl",panel:{type:"panel",html:function(){var e="";e='<table role="presentation" class="mce-panel mce-grid mce-grid-border">',e+="<tr>";for(var t=0;t<w.length;t++)e+='<td><a href="#" data-mce-index="'+t+'">'+(t+1)+"</a></td>";return e+="</tr>",e+="</table>",e+='<div class="mce-text-center">No Scaling</div>'}(),onmousemove:function(e){var t,i,n,a=e.target;if("A"==a.nodeName&&(t=c.dom.getParent(a,"table"),(i=parseInt(a.getAttribute("data-mce-index"),10))!=this.lastPos)){for(var l=0;l<w.length;l++)c.dom.toggleClass(t.rows[0].childNodes[l].firstChild,"mce-active",l<=i);n=w[i].value,t.nextSibling.innerHTML=i+1+" (fit within "+n[0]+" x "+n[1]+")",this.lastPos=i}},onmouseout:function(e){var t=e.target;if("A"==t.nodeName){for(var i=c.dom.getParent(t,"table"),n=0;n<w.length;n++)c.dom.toggleClass(i.rows[0].childNodes[n].firstChild,"mce-active",!1);i.nextSibling.innerHTML="No scale"}},onclick:function(e){var t,i,n,a,l,r,o,s,c,g,d,m,u,h,p;"A"==e.target.nodeName&&(c=e.target,g=parseInt(c.getAttribute("data-mce-index"),10),e.preventDefault(),t=b.find("#src"),i=b.find("#image_scale_label"),n=b.find("#width"),a=b.find("#height"),l=t.value(),v=parseInt(n.value(),10),f=parseInt(a.value(),10),newImageScale=g+1,newImageSize=w[g].value,(r=l)&&newImageScale&&(d=l,m=newImageScale,p="","/"===d[-1]&&(d=d.slice(0,-1)),d&&(2<(u=d.split("/")).length?"span"===(h=u[u.length-1]).substring(0,4)?p=parseInt(h.slice(4),10)===m?d:u.slice(0,-1).join("/")+"/span"+m:"image"===h&&(p=d+"/span"+m):p=d+"/image/span"+m),r=p,t.value(r),o=newImageSize[0],s=newImageSize[1],0!==v&&(s=Math.round(o/v*f)),n.value(newImageSize[0]),a.value(s),console.log("setting image size",l,r,newImageScale),i.text(y(r,newImageScale))),b.find("#show_preview")[0].checked()&&x(),this.hide())}}},{type:"label",name:"image_scale_label",tooltip:"Size choices (1-12) are relative to the maximum width.",text:y()}]},{type:"container",layout:"flex",direction:"row",align:"center",spacing:5,items:[{type:"label",text:"Width and Height",tooltip:"Optionally, set width and size directly."},{name:"width",tooltip:"In pixels. Use integer number.",type:"textbox",maxLength:3,size:3,onchange:r},{type:"label",text:"x"},{name:"height",tooltip:"In pixels. Use integer number.",type:"textbox",maxLength:3,size:3,onchange:r},{name:"constrain",type:"checkbox",checked:!0,tooltip:"Do not distort -- keep original proportions.",text:"Keep aspect ratio"}]}]}]},{name:"show_preview",type:"checkbox",checked:!0,tooltip:"Show live preview of image in the edit window.",text:"Show Preview"}];c.settings.image_advtab?(l&&(t.hspace=o(l.style.marginLeft||l.style.marginRight),t.vspace=o(l.style.marginTop||l.style.marginBottom),t.border=o(l.style.borderWidth),t.style=c.dom.serializeStyle(c.dom.parseStyle(c.dom.getAttrib(l,"style")))),b=c.windowManager.open({title:"Insert/edit image",data:t,bodyType:"tabpanel",body:[{title:"General",type:"form",padding:20,labelGap:30,spacing:10,items:s},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{label:"Alt text",name:"alt",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:function(){function e(e){return 0<e.length&&/^[0-9]+$/.test(e)&&(e+="px"),e}var t=b.toJSON(),i=a.parseStyle(t.style);delete i.margin,i["margin-top"]=i["margin-bottom"]=e(t.vspace),i["margin-left"]=i["margin-right"]=e(t.hspace),i["border-width"]=e(t.border),b.find("#style").value(a.serializeStyle(a.parseStyle(a.serializeStyle(i))))}},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:x})):b=c.windowManager.open({title:"Edit image",data:t,body:s,onSubmit:x})}c.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:e(t),stateSelector:"img:not([data-mce-object])"}),c.addMenuItem("image",{icon:"image",text:"Insert image",onclick:e(t),context:"insert",prependToContext:!0})});